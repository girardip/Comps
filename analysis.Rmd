---
title: "Analysis"
author: "Pedro Girardi"
date: "January 27, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Packages}
library(tidyverse)
library(data.table)
library(lme4)
library(plm)
```

## Importing df

```{r}
complete.df = fread("complete.csv")
```

## Recoding Variables

Variables:

v203: Gender (Male=1)
v208: Ethnicity (White=1, Black=2, Yellow=3, Mixed=4, Native=5, Ignored=9)
v4191: Income (999999999 = ignored)
v301: Writes/reads? (Yes=1, No=2, 0="Deleted by the surveyer", NA=NA)
v307: schooling (a mess...)/turn into factor
v234: age

ADD 409 (TYPE OF WORKER!!!!)

```{r}
complete.df = complete.df %>% mutate(Gender = as.factor(v203),
                       Ethnicity = as.factor(v208),
                       Literacy = as.factor(v301),
                       Schooling = as.factor(v307),
                       EmploymentType = as.factor(v409),
                       v035 = as.factor(v035),
                       idind = as.factor(idind)) %>% 
                              select(-v040, -v050, -v203, -v208, -v301, -v307, -v409,
                                     -starts_with("vD"))
complete.df$Schooling = as.factor(ifelse(is.na(complete.df$Schooling), "NoSchooling", complete.df$Schooling))
levels(complete.df$Gender) = c("Male", "Female")
levels(complete.df$Ethnicity) = c("White", "Black", "Yellow", "Mixed", "Native", "Ignored")
levels(complete.df$Literacy) = c("Yes", "No")
levels(complete.df$Schooling) = c("Primary", "HighSchool_1", "HighSchool_2",
                                  "MiddleSchool", "HighSchool_3", "College",
                                  "AdultsSchool", "PreSchool", "Graduate",
                                  "NoSchooling")
levels(complete.df$EmploymentType) = c("Domestic", "Employee") #note that people who own their own business don't report income
```

## Visually checking for mixed effects

```{r, cache=T, eval=F}
set.seed(2)
ggplot(complete.df %>% filter(idind %in% sample(complete.df$idind, size = 25)),
       aes(x=lagInflationTax, y=realWage)) +
  geom_point(aes(col=idind)) +
  geom_smooth(aes(col=idind), method = "lm", se = F) +
  theme_minimal() +
  theme(legend.position="none")
```

## Fitting LME model

Worrying about LME not being the ideal. Needs to test with Hausman test.


```{r}
set.seed(1)
sampleInd = sample(complete.df$idind, size = length(complete.df$idind)/100)
sample_complete.df =  complete.df %>% filter(idind %in% sampleInd)
```

```{r Testing random slopes, eval=F}
lmer1 <- lmer(log(realWage) ~ lagInflationTax + ChangeInGDP +
                (Gender + Ethnicity + Literacy + Schooling + EmploymentType)*lagInflationTax+
                (1 | v035)+(lagInflation|v035:idind), data = complete.df)
summary(lmer1)

lmer2 = lmer(log(realWage) ~ v035 + lagInflationTax + ChangeInGDP +
                (Gender + Ethnicity + Literacy + Schooling)*lagInflationTax+
               (1 | v035)+(1 | v035:idind), data = sample_complete.df)
summary(lmer2)

deviance_lme = 2*(logLik(lmer1)-logLik(lmer2))
.5*(1-pchisq(deviance_lme, 2)) + .5*(1-pchisq(deviance_lme, 1)) #pvalue of 0 indicates you need the random slope! 
AIC(lmer1)
AIC(lmer2)
# needs random slopes, which means that people are impacted differently by inflation
```

```{r Working with fixed effects, eval=F}
lmer1_fe = update(lmer1, REML=F)
lmer3_fe = update(lmer1_fe, . ~ . -lagInflationTax:Ethnicity -lagInflationTax:Literacy -lagInflationTax:Gender)
summary(lmer1_fe)
summary(lmer3_fe)
D <- 2*(logLik(lmer1_fe)-logLik(lmer3_fe))
1-pchisq(D, (length(summary(lmer1_fe)$coefficients[,1]))-length(summary(lmer3_fe)$coefficients[,1]))[[1]]
# shorter model is appropriate
```

## be sure to test with hausman 

* remove people w fewer than 3 

* run hausmann test 

Decided not to have random effects for inflation coefficient so to avoid issues with hausmann test (trade-off)

Checked with Katie, sampling expert, on potential issues with subsetting and decided to subset (issue with power may exist, but mostly for very specific interactions)

#Selecting individuals with 8 observations

```{r}
idIndsObserved = complete.df %>% group_by(idind) %>% summarise(nObs = n())
mean(idIndsObserved$nObs>4) #7.5% of individuals, or 33000 individuals, or ~250k observations
sum(idIndsObserved$nObs>4)
idsFull = idIndsObserved$idind[idIndsObserved$nObs==8]
```

```{r Selecting only individuals with 8 observations}
onlyFull.df = complete.df %>% 
  filter(idind %in% idsFull)
```

```{r Fitting fixef}
fixed = plm(log(realWage) ~ lagInflationTax + ChangeInGDP +
                (v035 +Gender + Ethnicity + Literacy +
                   Schooling + EmploymentType)*lagInflationTax,
            data = onlyFull.df, index = c("idind"), model = "within") 

random = plm(log(realWage) ~ lagInflationTax + ChangeInGDP +
                (v035 +Gender + Ethnicity + Literacy +
                   Schooling + EmploymentType)*lagInflationTax,
            data = onlyFull.df, index = c("idind"), model = "random") 
```

```{r}
summary(fixed)
summary(random)
```

```{r}
phtest(fixed, random)

summary(complete.df$Ethnicity)
summary(onlyFull.df$Ethnicity)
```
think about lag gdp as an instrument 

check minimum wage thing

maybe add age to the model
